<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Professor - Curso de Scratch</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="main-layout">
        <header class="header">
            <div class="logo">
                <img src=img/scratch.png height=150 width=150 alt="Scratch Logo" id="scratch-logo">
            </div>
            <nav>
                <ul class="nav-menu">
                    <li id="navAdmin"><a href="admin.html">Administra√ß√£o de Usu√°rios</a></li>
                    <li id="navBancoDados"><a href="database.html">Banco de Dados</a></li>
                    <li id="navDiarioClasseProf"><a href="teacher-diary.html">Di√°rio de Classe</a></li>
                    <li id="navMateriaisProf"><a href="teacher-materials.html">Materiais</a></li>
                    
                    <li class="dropdown">
                        <a href="#">Links Externos ‚ñº</a>
                        <div class="dropdown-content">
                            <a href="https://scratch.mit.edu/" target="_blank">Scratch Website</a>
                            <a href="https://scratch.mit.edu/projects/editor/" target="_blank">Editor do Scratch</a>
                            <a href="https://scratch.mit.edu/ideas" target="_blank">Ideias de Projetos</a>
                            <a href="https://www.youtube.com/results?search_query=scratch+tutorial+portugu√™s" target="_blank">Tutoriais YouTube</a>
                            <a href="https://wayground.com/home-v1?lng=pt-BR" target="_blank">Wayground (Quizizz)</a>
                        </div>
                    </li>
                    <li class="dropdown">
                        <a href="#">Informa√ß√µes ‚ñº</a>
                        <div class="dropdown-content">
                            <a href="horario-onibus.html">Hor√°rio do √înibus</a>
                            <a href="calendario-aulas.html">Calend√°rio das Aulas</a>
                            <a href="#" onclick="abrirWhatsApp()">Link do grupo do WhatsApp</a>
                            <a href="endereco-aula.html">Endere√ßo do Local das Aulas</a>
                            <a href="contato.html">Contato</a>
                        </div>
                    </li>
                </ul>
            </nav>
            <div class="user-profile">
                <div class="user-avatar"><img src=img/icon-user.png height= 40px width= 40px alt="Icone do Perfil"></div>
            </div>
        </header>
        
        <main class="content">
            <h1 class="page-title">Dashboard do Professor</h1>
            
            <div class="teacher-stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalStudents">0</div>
                    <div class="stat-label">Alunos Matriculados</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" id="completedClasses">0</div>
                    <div class="stat-label">Aulas Ministradas</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" id="averageAttendance">0%</div>
                    <div class="stat-label">Frequ√™ncia M√©dia</div>
                </div>
            </div>
            
            <div class="quick-actions">
                <h2>A√ß√µes R√°pidas</h2>
                <div class="action-grid">
                    <a href="database.html" class="quick-action-btn">
                        <div class="action-icon">üóÑÔ∏è</div>
                        <div class="action-text">Banco de Dados</div>
                    </a>
                    
                    <a href="teacher-diary.html" class="quick-action-btn">
                        <div class="action-icon">üìã</div>
                        <div class="action-text">Marcar Frequ√™ncia</div>
                    </a>
                    
                    <a href="teacher-materials.html" class="quick-action-btn">
                        <div class="action-icon">üìÅ</div>
                        <div class="action-text">Gerenciar Materiais</div>
                    </a>
                </div>
            </div>
            
        </main>
    </div>
    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            await loadTeacherDashboardStats();
        });

        async function loadTeacherDashboardStats() {
            try {
                // 1. Contar Alunos Matriculados
                const studentsResponse = await fetch('http://127.0.0.1:5000/alunos');
                if (!studentsResponse.ok) throw new Error('Erro ao buscar alunos.');
                const students = await studentsResponse.json();
                document.getElementById('totalStudents').textContent = students.length;

                // 2. Contar Aulas Ministradas (status 'completed')
                const classesResponse = await fetch('http://127.0.0.1:5000/classes');
                if (!classesResponse.ok) throw new Error('Erro ao buscar aulas.');
                const classes = await classesResponse.json();
                const completedClassesCount = classes.filter(cls => cls.status === 'completed').length;
                document.getElementById('completedClasses').textContent = completedClassesCount;

                // 3. Calcular Frequ√™ncia M√©dia
                // Para calcular a frequ√™ncia m√©dia, precisamos do total de presen√ßas e do total de aulas para todos os alunos.
                // Isso pode ser feito buscando todos os registros de presen√ßa e todas as aulas.
                const attendanceRecordsResponse = await fetch('http://127.0.0.1:5000/attendance');
                if (!attendanceRecordsResponse.ok) throw new Error('Erro ao buscar registros de presen√ßa.');
                const allAttendanceRecords = await attendanceRecordsResponse.json();

                let totalPresences = 0;
                let totalPossiblePresences = 0; // Total de registros esperados (alunos * aulas)

                // Contar presen√ßas e faltas para todos os alunos em todas as aulas registradas
                allAttendanceRecords.forEach(record => {
                    if (record.attendance_status === 'P') {
                        totalPresences++;
                    }
                });
                
                // Calcular o total de "slots" de presen√ßa que deveriam existir
                // Isso √© o n√∫mero de alunos * n√∫mero de aulas.
                // No entanto, para ser mais preciso, devemos contar apenas as aulas que j√° aconteceram (completed ou current)
                const relevantClasses = classes.filter(cls => cls.status === 'completed' || cls.status === 'current');
                totalPossiblePresences = students.length * relevantClasses.length;

                // Se n√£o houver alunos ou aulas, a frequ√™ncia m√©dia √© 0
                if (totalPossiblePresences === 0) {
                    document.getElementById('averageAttendance').textContent = '0%';
                } else {
                    const average = (totalPresences / totalPossiblePresences) * 100;
                    document.getElementById('averageAttendance').textContent = `${average.toFixed(0)}%`;
                }

            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas do professor:', error);
                // Voc√™ pode adicionar um modal de mensagem aqui se quiser feedback visual para o professor
            }
        }

        // Fun√ß√µes de navega√ß√£o e logout (copiadas de script.js para garantir acesso)
        function abrirWhatsApp() {
            const whatsappLink = "https://chat.whatsapp.com/GHZuEpQhb5uGFROPWioy9o?mode=ac_c";
            window.open(whatsappLink, '_blank');
        }

        async function logout() {
            const userId = localStorage.getItem("userId");
            if (userId) {
                try {
                    await fetch(`http://127.0.0.1:5000/logout/${userId}`, {
                        method: 'POST',
                    });
                    console.log('Status online atualizado para offline.');
                } catch (error) {
                    console.error('Erro ao atualizar status de logout:', error);
                }
            }
            localStorage.removeItem("isLoggedIn");
            localStorage.removeItem("userId");
            localStorage.removeItem("username");
            localStorage.removeItem("userRole");
            localStorage.removeItem("userName");
            localStorage.removeItem("userStudentId");
            window.location.href = "index.html";
        }

        const userAvatar = document.querySelector(".user-avatar")
        if (userAvatar) {
            userAvatar.addEventListener("click", () => {
                if (confirm("Deseja fazer logout?")) {
                    logout()
                }
            })
            userAvatar.style.cursor = "pointer"
            userAvatar.title = "Clique para fazer logout"
        }
    </script>
</body>
</html>
